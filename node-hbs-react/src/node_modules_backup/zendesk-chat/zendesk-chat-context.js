const config = require('lc-app-config');
const logger = require('lc-logger');

function zendeskContext() {
  return (req, res, next) => {
    const { loanAppInProgress: { borrowers } = {}, loanAppInProgressActorId } = req;
    if (!borrowers || !borrowers.length || !loanAppInProgressActorId) {
      logger.error(
        'ZENDESK MIDDLEWARE: Error with loan AppInProggress info'
      );
      return next();
    }
    // Adding requester info for Zopim
    const { firstName: name, email } = borrowers.find(
      ({ primary }) => primary
    );
    if (!name) {
      logger.warn(
        { borrowerId: loanAppInProgressActorId },
        'ZENDESK MIDDLEWARE: Firstname was not found'
      );
    }
    if (!email) {
      logger.warn(
        { borrowerId: loanAppInProgressActorId },
        'ZENDESK MIDDLEWARE: Email was not found'
      );
    }

    // Getting the token
    const token = config.get('app.zopim.token');

    if (!token) {
      logger.error(
        'ZENDESK MIDDLEWARE: Token has not found'
      );
      return next();
    }

    req.zendeskChatContext = {
      zendeskChatConfigStr: JSON.stringify({ token, name, email })
    };

    return next();
  };
}
module.exports = zendeskContext;
