# Zendesk Chat Module

## Overview

Zendesk-chat includes 3 sub-modules:
- [Zendesk Chat Context](#zendesk-chat-context-(Middleware))
- [Handlebar template](#handlebar-template)
- [Javascript module](#javascript-module)

And is necessary setup them each one.

## Zendesk Chat Context (Middleware)

A middleware used for setting up context data needed for the ZendeskChat.

### Dependencies

This middleware depends on the following middleware:
- get-loan-app-in-progress

Those should be added before `zendesk-chat-context` so they can provide the required data that this middleware needs.

Specifically we need `loanAppInProgress` to exist inside request object and providing a `borrowers` 
array from which we will take the first element of that array and get the following properties for the borrower:
- firstName
- email

In summary we need a `request.loanAppInProgress` object with this minimal structure:
``` js
{
  "loanAppInProgress": {
    "borrowers": [{
      firstName: "John",
      email: "john@email.com"
    }]
  }
}
```

Otherwise that data should be provided to the request object prior to adding this middleware.

If not provided or you run it without the required dependencies an exception may be thrown trying to access those properties listed above.

### Overview

Apart from data requirements cited above, this middleware sets a property named `zendeskChatContext` on the request object which should be retrieved and passed (or augmented with more page context data) to the render method of the page.

The minimal property structure for `zendeskChatContext` object is:

``` js
{
  zopimDataStr: "{    token: 'SomeToken',    name: 'John',    email: 'John@email.com'  }"
}
```

#### Import && export / Middleware 
This is done via adding a middleware file on boreas project.
```js
// src/middleweare/zendesk-chat-context.js
const zendeskChatMiddleware = require('zendesk-chat/zendesk-chat-middleware');

module.exports = zendeskChatMiddleware;
```

#### Import / Require Component

This is done via the middleware array of the server setup.

```js
// src/pages/your-page/your-page-server.js

...

module.exports = (boreas, register) => {
  register(null, {
    path: '/some-page',
    middleware: ['authorize'],
    action: [
      {
        path: '/',
        middleware: ['get-loan-apps', 'get-loan-app-in-progress', 'zendesk-chat-context'],
        get(req, res) {
          const context = Object.assign({}, req.zendeskChatContext, {
            headerTitle: 'Some Title', // add whatever data needed
            backUrl: '/dashboard' // as well as override data if needed
          });

          return res.render('some-page/some-page-template', context);
        }
      }
    ]
  });
};

...
```

## Handlebar template
In your handlebar template is necessary include this line:
```hbs
<!-- src/pages/your-page/your-page-template.hbs --> 
...

  {{> zendesk-chat/zendesk-chat-template}}

...
```

## Javascript module
In your js client file is necesary import the javascript module:

```js
// src/pages/your-page/your-page-client.js

...

 /* eslint-disable */
// Importing Zendesk widget
import zendeskChat from 'zendesk-chat';
/* eslint-enable */

...

```

## Important notes
  - Currently Heaptrack module executes heaptrack events.
  - Is necessary add to the polices some url on config file:
  ```js
    security: {
      headers: {
        csp: {
          policy: {
            ...
            'script-src': '... *.zopim.com/ wss://*.zopim.com/ *.zopim.io/',
            'connect-src': '... *.zopim.com/ wss://*.zopim.com/ *.zopim.io/'
            ...
          }
        }
      }
    }
  ```
  