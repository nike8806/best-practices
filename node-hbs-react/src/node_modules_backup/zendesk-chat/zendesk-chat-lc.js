const heaptrackLib = require('heap-track/heap-track.js');

const heapTrackChat = heaptrackLib.bind(null, 'Zendesk Chat');

/**
 * Function to init zopim chat
 * @param {Object} requester
 * @param {String} requester.token - Zopim token
 * @param {String} requester.name - Requester name
 * @param {String} requester.email - Requester name
 * @param {function} [onloadFunction] - On load callback, Optional
 */
function zopimInit({ token, name, email } = {}, onLoadCallback) {
  if (global.$zopim) {
    return;
  }

  const { document: d } = global;
  const s = 'script';

  /* eslint-disable */
  // Zendesk Zopim code
  var z=global.$zopim=function(c){
    $z._.push(c)}, $=z.s=
    d.createElement(s),e=d.getElementsByTagName(s)[0];z.set=function(o){z.set.
    _.push(o)};z._=[];z.set._=[];$.async=!0;$.setAttribute('charset','utf-8');
    $.src='https://v2.zopim.com/?'+token;z.t=+new Date;$.
    type='text/javascript';e.parentNode.insertBefore($,e);
  /* eslint-enable */

  $.onload = () => {
    const { livechat: zopimLiveChat } = global.$zopim;
    zopimLiveChat.setName(name);
    zopimLiveChat.setEmail(email);
    zopimLiveChat.window.hide();

    zopimLiveChat.setOnConnected(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat connected' });
    });
    zopimLiveChat.setOnChatStart(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat started' });
    });
    zopimLiveChat.setOnChatEnd(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat ended' });
    });
    zopimLiveChat.setOnStatus((status) => {
      if (status === 'online') {
        heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat status changed', status: 'online' });
      } else if (status === 'offline' && !zopimLiveChat.isChatting()) {
        heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat status changed', status: 'offline' });
      }
    });
    zopimLiveChat.setOnUnreadMsgs(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat unread messages' });
    });
    zopimLiveChat.window.onShow(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat widget clicked', status: 'open' });
    });
    zopimLiveChat.window.onHide(() => {
      heapTrackChat({ TYPE: 'Zendesk Chat', ACTION: 'chat widget clicked', status: 'hide' });
    });

    if (onLoadCallback) {
      onLoadCallback();
    }
  };
}

module.exports = { init: zopimInit };
